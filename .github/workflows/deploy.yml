name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to VM
        run: |
          cd /root/study-material-service
          
          # Fetch latest from remote
          git fetch origin
          
          # Reset to exact remote version (discards local changes)
          git reset --hard origin/main
          
          # Clean untracked files (respects .gitignore)
          git clean -fd
          
          # Write .env file
          cat > .env << 'EOF'
          ${{ secrets.DOCKER_COMPOSE_ENV }}
          EOF
          
          # Build and restart containers
          docker compose build
          docker compose up -d
          
          # Show status
          docker compose ps